#!/bin/sh

# A dwm_bar function to display information regarding system memory
# Based on dwm_resources by Joe Standring <git@joestandring.com>
# GNU GPLv3

dwm_memory () {
	# Handle click actions
	case "$BLOCK_BUTTON" in
		1) st -e tmux new-session -A -s btop btop & exit 0 ;;
		3) notify-send "Top Memory Processes" "$(ps axo pid,comm,%mem --sort=-%mem | head -n 6)" ; exit 0 ;;
	esac

	# Gather memory usage data
	free_output=$(free | grep Mem)
	MEMUSED_KB=$(echo $free_output | awk '{print $3}')
	MEMTOTAL_KB=$(echo $free_output | awk '{print $2}')
	
	# Calculate memory percentage
	MEMPERCENT=$(echo "$MEMUSED_KB $MEMTOTAL_KB" | awk '{printf "%.0f", ($1/$2)*100}')
	
	# Check battery status (try BAT1 first, then BAT0)
	BAT="BAT1"
	if [ ! -f "/sys/class/power_supply/$BAT/status" ]; then
		BAT="BAT0"
	fi

	# Determine if running on battery and apply appropriate threshold
	if [ -f "/sys/class/power_supply/$BAT/status" ]; then
		STATUS=$(cat /sys/class/power_supply/$BAT/status)
		if [ "$STATUS" = "Discharging" ]; then
			# On battery: print if memory utilization is above 15%
			if [ "$MEMPERCENT" -gt 15 ]; then
				# Convert KB to GB and round to whole number
				MEMUSED_GB=$(echo "$MEMUSED_KB" | awk '{printf "%.0f", $1/1024/1024}')
				if [ "$MEMUSED_GB" -ge 1 ]; then
					MEMUSED="${MEMUSED_GB}G"
				else
					# If less than 1GB, show in MB
					MEMUSED_MB=$(echo "$MEMUSED_KB" | awk '{printf "%.0f", $1/1024}')
					MEMUSED="${MEMUSED_MB}M"
				fi
				printf " %s\n" "$MEMUSED"
			fi
		else
			# Plugged in: print if memory utilization is above 75%
			if [ "$MEMPERCENT" -gt 75 ]; then
				# Convert KB to GB and round to whole number
				MEMUSED_GB=$(echo "$MEMUSED_KB" | awk '{printf "%.0f", $1/1024/1024}')
				if [ "$MEMUSED_GB" -ge 1 ]; then
					MEMUSED="${MEMUSED_GB}G"
				else
					# If less than 1GB, show in MB
					MEMUSED_MB=$(echo "$MEMUSED_KB" | awk '{printf "%.0f", $1/1024}')
					MEMUSED="${MEMUSED_MB}M"
				fi
				printf " %s\n" "$MEMUSED"
			fi
		fi
	else
		# Fallback: assume plugged in if battery status cannot be detected
		if [ "$MEMPERCENT" -gt 75 ]; then
			# Convert KB to GB and round to whole number
			MEMUSED_GB=$(echo "$MEMUSED_KB" | awk '{printf "%.0f", $1/1024/1024}')
			if [ "$MEMUSED_GB" -ge 1 ]; then
				MEMUSED="${MEMUSED_GB}G"
			else
				# If less than 1GB, show in MB
				MEMUSED_MB=$(echo "$MEMUSED_KB" | awk '{printf "%.0f", $1/1024}')
				MEMUSED="${MEMUSED_MB}M"
			fi
			printf " %s\n" "$MEMUSED"
		fi
	fi

}

dwm_memory
