#!/bin/sh

# A dwm_bar function to display information regarding system storage
# Based on dwm_resources by Joe Standring <git@joestandring.com>
# GNU GPLv3

dwm_storage () {
	# Calculate actual space used by /home directory
	HOME_USED=$(du -sh /home 2>/dev/null | awk '{print $1}')

	# Determine filesystem type for root filesystem and collect disk usage
	filesystem=$(df -Th / | awk 'FNR == 2{print $2}')

	# Calculate total disk usage percentage for root filesystem
	if [ "$filesystem" = "btrfs" ]; then
		# For btrfs, get used and total from btrfs filesystem usage
		DISK_USED=$(btrfs filesystem usage -H / 2>/dev/null | awk '/   Used:/ {print $2}' | sed 's/[^0-9.]//g')
		DISK_TOTAL=$(btrfs filesystem usage -H / 2>/dev/null | awk '/Device size/ {print $3}' | sed 's/[^0-9.]//g')
		if [ -n "$DISK_USED" ] && [ -n "$DISK_TOTAL" ] && [ "$DISK_TOTAL" != "0" ]; then
			DISK_PERCENT=$(echo "$DISK_USED $DISK_TOTAL" | awk '{printf "%.0f", ($1/$2)*100}')
		else
			DISK_PERCENT="0"
		fi
		# For warning calculation, convert to GB
		DISK_USED_GB=$(echo "$DISK_USED" | awk '{printf "%d", $1/1024/1024/1024}')
		DISK_TOTAL_GB=$(echo "$DISK_TOTAL" | awk '{printf "%d", $1/1024/1024/1024}')
		if [ -n "$DISK_USED_GB" ] && [ -n "$DISK_TOTAL_GB" ] && [ "$DISK_TOTAL_GB" -gt 0 ]; then
			AVAIL_GB=$((DISK_TOTAL_GB - DISK_USED_GB))
		else
			AVAIL_GB=""
		fi
	else
		# For other filesystems, use df -P to get 1K blocks (POSIX mode)
		df_output=$(df -P / | tail -n 1)
		DISK_USED_BLOCKS=$(echo $df_output | awk '{print $3}')
		DISK_TOTAL_BLOCKS=$(echo $df_output | awk '{print $2}')
		DISK_AVAIL_BLOCKS=$(echo $df_output | awk '{print $4}')

		# Calculate percentage from 1K blocks
		if [ -n "$DISK_USED_BLOCKS" ] && [ -n "$DISK_TOTAL_BLOCKS" ] && [ "$DISK_TOTAL_BLOCKS" != "0" ]; then
			DISK_PERCENT=$(echo "$DISK_USED_BLOCKS $DISK_TOTAL_BLOCKS" | awk '{printf "%.0f", ($1/$2)*100}')
		else
			DISK_PERCENT="0"
		fi

		# For warning, convert available blocks to GB (1K blocks / 1024 / 1024 = GB)
		if [ -n "$DISK_AVAIL_BLOCKS" ] && [ "$DISK_AVAIL_BLOCKS" -gt 0 ]; then
			AVAIL_GB=$(echo "$DISK_AVAIL_BLOCKS" | awk '{printf "%d", $1/1024/1024}')
		else
			AVAIL_GB=""
		fi
	fi

	# Display the output: /home usage and total disk percentage (only if > 85%)
	if [ "$DISK_PERCENT" -gt 85 ] 2>/dev/null; then
		printf "󰋜 %s ·  %s%%\n" "$HOME_USED" "$DISK_PERCENT"
	else
		printf "󰋜 %s\n" "$HOME_USED"
	fi

	# Storage warning notification (check available space on root filesystem)
	# Only trigger if AVAIL_GB is a valid positive integer less than 15
	if [ -n "$AVAIL_GB" ] && [ "$AVAIL_GB" -ge 0 ] 2>/dev/null && [ "$AVAIL_GB" -lt 15 ] 2>/dev/null; then
		notify-send "HD cheio"
	fi
}

dwm_storage
